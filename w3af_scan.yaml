---
  - hosts: w3af_servers
    become: true
    tasks:

    - name: Move w3af profile file to w3af server
      copy:
        src: ${env.WORKSPACE}/${env.BUILD_ID}_dast.w3af
        dest: /opt/w3af/jenkins/dast_profiles/${env.WORKSPACE}/${env.BUILD_ID}_dast.w3af
        group: root
        user: root
        mode: 0755

    - name: initate web crawl
      shell: '{{ item }}'
      with_items:
        - "wget --no-check-certificate --bind-address=10.1.3.81 --keep-session-cookies --save-cookies cookies.txt --post-data '$wget_dataFormat' https://$qaIP$loginURL"
        - "wget --no-check-certificate --bind-address=10.1.3.81 --load-cookies cookies.txt --no-clobber --convert-links --random-wait -r -p --level 1 -E -e robots=off -U FoChromny https://$qaIP$targetURL"

    - name: Check if w3af dast profile exsists
      stat:
        path: /opt/w3af/jenkins/dast_profiles/${env.WORKSPACE}/${env.BUILD_ID}_dast.w3af
      register: result

    - name: initate vul  if w3af file exists
      command: /opt/w3af/w3af_console --no-update -s ${env.BUILD_ID}_dast.w3af"
      when: result.stat.exists == true 
