---
  - hosts: w3af_servers
    become: true
    tasks:

    - name: ensure directory exists for dast profile
      file:
        path=/opt/w3af/jenkins/dast_profiles/f5_dynamic_waf
        recurse=yes
        state=directory

    - name: Move w3af profile file to w3af server
      copy:
        src: "./{{ build_id }}_dast.w3af"
        dest: "/opt/w3af/jenkins/dast_profiles/f5_dynamic_waf/{{ build_id }}_dast.w3af"
        group: root
        owner: root
        mode: 0755

    - name: initate web crawl
      shell: '{{ item }}'
      warn: false
      with_items:
        - "wget --no-check-certificate --bind-address={{ vulntoolip }} --keep-session-cookies --save-cookies cookies.txt --post-data '{{ wget_dataFormat }}' https://{{ qaip }}/{{ targetlogin }}"
        - "wget --no-check-certificate --bind-address={{ vulntoolip }} --load-cookies cookies.txt --no-clobber --convert-links --random-wait -r -p --level 1 -E -e robots=off -U FoChromny https://{{ qaip }}/{{ targeturl }}"

    - name: Check if w3af dast profile exsists
      stat:
        path: /opt/w3af/jenkins/dast_profiles/f5_dynamic_waf/{{ build_id }}_dast.w3af
      register: result

    - name: initate vul if w3af file exists
      shell: "/opt/w3af/w3af_console --no-update -s /opt/w3af/jenkins/dast_profiles/f5_dynamic_waf/{{ build_id }}_dast.w3af"

    - name: wait for scan to complete
      wait_for:
        path: "/opt/w3af/jenkins/dast_profiles/f5_dynamic_waf/{{ build_id }}_dast.w3af"

    - name: ensure directory exists for xml output
      file:
        path=/opt/w3af/jenkins/asm_xml_results/f5_dynamic_waf
        recurse=yes
        state=directory

    - name: fetch DAST xml_f5asm output file
      fetch:
        flat: true
        src: "/opt/w3af/jenkins/asm_xml_results/f5_dynamic_waf/{{ build_id }}_dast.xml"
        dest: "{{ workspace }}/{{ build_id }}_dast.xml"
